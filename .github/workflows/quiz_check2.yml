name: Quiz Auto Check

on:
  push:
    paths:
      - 'students/**/quiz_*answers.md'
  pull_request:
    paths:
      - 'students/**/quiz_*answers.md'

permissions:
  contents: write

jobs:
  quiz-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
        run: |
          mkdir -p grades
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã..."
          for quiz in $(ls tests/quiz_*.md 2>/dev/null); do
            quiz_name=$(basename "$quiz")
            echo "–ü—Ä–æ–≤–µ—Ä—è—é $quiz_name"
            # –∏—â–µ–º –æ—Ç–≤–µ—Ç—ã —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ quiz
            for answer in $(find students -type f -name "${quiz_name/quiz_/quiz_*answers.md}" 2>/dev/null); do
              correct=$(grep -c "‚úÖ" "$answer" || true)
              total=$(grep -c "^[0-9][.)]" "$quiz" || grep -c "^\\d\\." "$quiz" || true)
              echo "$(date +'%Y-%m-%d'),${answer},${correct}/${total}" >> grades/quiz_results.csv
              echo "‚úÖ $answer ‚Äî $correct –∏–∑ $total"
            done
          done

      - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ summary.md
        run: |
          if [ -f grades/quiz_results.csv ]; then
            {
              echo "# –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤"
              echo
              echo "| –î–∞—Ç–∞ | –§–∞–π–ª | –†–µ–∑—É–ª—å—Ç–∞—Ç |"
              echo "|------|------|-----------|"
              while IFS=, read -r date file result; do
                echo "| $date | $file | $result |"
              done < grades/quiz_results.csv
            } > grades/summary.md
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add grades/summary.md grades/quiz_results.csv
            git commit -m "update quiz summary [skip ci]" || true
            git push || true
          else
            echo "–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è summary.md"
          fi
