name: Quiz Auto Check

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  quiz-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
        run: |
          mkdir -p grades
          touch grades/quiz_results.csv
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã..."

          found_any=false

          for quiz in $(ls tests/quiz_*.md 2>/dev/null || true); do
            quiz_name=$(basename "$quiz")
            echo "üß© –ü—Ä–æ–≤–µ—Ä—è—é $quiz_name"

            for answer in $(find students -type f -iname "quiz_*answers.md" 2>/dev/null); do
              found_any=true
              correct=$(grep -c "‚úÖ" "$answer" || true)
              total=$(grep -c "^[0-9]" "$quiz" || true)
              if [ "$total" -eq 0 ]; then total=3; fi

              # –í—ã—á–∏—Å–ª—è–µ–º –æ—Ü–µ–Ω–∫—É
              grade="2"
              if [ "$correct" -eq "$total" ]; then
                grade="5"
              elif [ "$correct" -ge $((total-1)) ]; then
                grade="4"
              elif [ "$correct" -ge 1 ]; then
                grade="3"
              fi

              echo "$(date +'%Y-%m-%d'),${answer},${correct}/${total},${grade}" >> grades/quiz_results.csv
              echo "‚úÖ $answer ‚Äî $correct –∏–∑ $total (–û—Ü–µ–Ω–∫–∞: $grade)"
            done
          done

          if [ "$found_any" = false ]; then
            echo "‚öôÔ∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ ‚Äî —Å–æ–∑–¥–∞—é –¥–µ–º–æ-–ø—Ä–∏–º–µ—Ä..."
            mkdir -p students/demo
            echo "# –û—Ç–≤–µ—Ç—ã Demo-—Å—Ç—É–¥–µ–Ω—Ç–∞" > students/demo/quiz_01_answers.md
            echo "1. ‚úÖ GitHub ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏—è–º–∏" >> students/demo/quiz_01_answers.md
            echo "2. ‚úÖ –ö–æ–º–º–∏—Ç ‚Äî —ç—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞" >> students/demo/quiz_01_answers.md
            echo "3. ‚ùå Push ‚Äî —ç—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∞ —Å GitHub –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä" >> students/demo/quiz_01_answers.md
            echo "$(date +'%Y-%m-%d'),students/demo/quiz_01_answers.md,2/3,4" >> grades/quiz_results.csv
          fi

      - name: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ summary.md
        run: |
          echo "# –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤" > grades/summary.md
          echo "" >> grades/summary.md
          echo "| –î–∞—Ç–∞ | –§–∞–π–ª | –†–µ–∑—É–ª—å—Ç–∞—Ç | –û—Ü–µ–Ω–∫–∞ |" >> grades/summary.md
          echo "|------|------|-----------|--------|" >> grades/summary.md
          cat grades/quiz_results.csv | while IFS=, read -r date file result grade; do
            echo "| $date | $file | $result | $grade |" >> grades/summary.md
          done

      - name: Commit and Push Results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add grades students/demo || true
          git commit -m "–ê–≤—Ç–æ–æ—Ç—á—ë—Ç —Å –æ—Ü–µ–Ω–∫–∞–º–∏ [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push || true
