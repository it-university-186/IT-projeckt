name: Quiz Auto Check

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  quiz-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
        run: |
          mkdir -p grades
          touch grades/quiz_results.csv
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã..."

          found_any=false
          for quiz in $(ls tests/quiz_*.md 2>/dev/null || true); do
            quiz_name=$(basename "$quiz")
            echo "üß© –ü—Ä–æ–≤–µ—Ä—è—é $quiz_name"

            for answer in $(find students -type f -iname "quiz_*answers.md" 2>/dev/null); do
              found_any=true
              correct=$(grep -c "‚úÖ" "$answer" || true)
              total=$(grep -c "^[0-9]" "$quiz" || true)
              if [ "$total" -eq 0 ]; then total=3; fi
              echo "$(date +'%Y-%m-%d'),${answer},${correct}/${total}" >> grades/quiz_results.csv
              echo "‚úÖ $answer ‚Äî $correct –∏–∑ $total"
            done
          done

          if [ "$found_any" = false ]; then
            echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤."
            echo "$(date +'%Y-%m-%d'),–Ω–µ—Ç_—Ñ–∞–π–ª–æ–≤,0/0" >> grades/quiz_results.csv
          fi

      - name: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–∞ summary.md
        run: |
          echo "# –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤" > grades/summary.md
          echo "" >> grades/summary.md
          echo "| –î–∞—Ç–∞ | –§–∞–π–ª | –†–µ–∑—É–ª—å—Ç–∞—Ç |" >> grades/summary.md
          echo "|------|------|-----------|" >> grades/summary.md
          cat grades/quiz_results.csv | while IFS=, read -r date file result; do
            echo "| $date | $file | $result |" >> grades/summary.md
          done

      - name: Commit and Push Results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add grades || true
          git commit -m "–ê–≤—Ç–æ–æ—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–∞—Ö [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push || true
