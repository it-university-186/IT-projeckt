name: Quiz Auto Check

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  quiz-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ—Å—Ç–æ–≤
        run: |
          mkdir -p grades
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã..."

          found_any=false

          for quiz in $(ls tests/quiz_*.md 2>/dev/null || true); do
            quiz_name=$(basename "$quiz")
            echo "üß© –ü—Ä–æ–≤–µ—Ä—è—é $quiz_name"

            for answer in $(find students -type f -name "${quiz_name/quiz_/quiz_*answers.md}" 2>/dev/null); do
              found_any=true
              correct=$(grep -c "‚úÖ" "$answer" || true)
              total=$(grep -c "^[0-9]" "$quiz" || true)
              if [ "$total" -eq 0 ]; then total=3; fi
              echo "$(date +'%Y-%m-%d'),${answer},${correct}/${total}" >> grades/quiz_results.csv
              echo "‚úÖ $answer ‚Äî $correct –∏–∑ $total"
              if [ "$correct" -eq 0 ]; then
                echo "‚ö†Ô∏è –í —Ñ–∞–π–ª–µ $answer –Ω–µ—Ç –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ (‚úÖ)"
              fi
            done
          done

          if [ "$found_any" = false ]; then
            echo "‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –æ—Ç–≤–µ—Ç–∞–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤."
          fi

      - name: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ summary.md
        run: |
          echo "# –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤" > grades/summary.md
          echo "" >> grades/summary.md
          echo "| –î–∞—Ç–∞ | –§–∞–π–ª | –†–µ–∑—É–ª—å—Ç–∞—Ç |" >> grades/summary.md
          echo "|------|------|-----------|" >> grades/summary.md
          if [ -f grades/quiz_results.csv ]; then
            cat grades/quiz_results.csv | while IFS=, read -r date file result; do
              echo "| $date | $file | $result |"
            done >> grades/summary.md
          else
            echo "| ‚Äì | –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö | ‚Äì |" >> grades/summary.md
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add grades/summary.md grades/quiz_results.csv || true
          git commit -m "update quiz summary [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push || true
